<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnimeSpace - Discover Anime</title>
    <style>
        /* General Resets and Body Styling */
        * { 
            padding: 0; 
            margin: 0; 
            box-sizing: border-box; 
        }
        body { 
            background-color: rgb(101, 207, 221); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            color: #333;
        }

        /* Header and Navigation */
        header {
            background: #222;
            color: #fff;
            padding: 16px 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .main-title {
            text-align: center;
            margin-bottom: 12px;
            font-size: 2em;
        }
        nav ul {
            list-style: none;
            display: flex;
            justify-content: center;
            gap: 30px;
        }
        nav ul li a {
            color: #fff;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.1em;
            transition: color 0.2s;
            cursor: pointer;
        }
        nav ul li a:hover {
            color: #66e0ff;
        }

        /* Controls Area */
        .controls-container {
            padding: 24px 16px;
            background-color: rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        .controls-grid {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            padding: 10px;
            border-right: 2px solid rgba(0,0,0,0.1);
        }
        .control-group:last-child {
            border-right: none;
        }
        .control-group label {
            font-weight: bold;
        }
        .control-group input[type="text"], .control-group select {
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1em;
            transition: box-shadow 0.2s;
        }
        .control-group input[type="text"]:focus, .control-group select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(151, 68, 167, 0.4);
        }
        .control-group button {
            padding: 10px 22px;
            border-radius: 8px;
            border: none;
            background: #9744a7;
            color: #fff;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        .control-group button:hover {
            background: #813a90;
            transform: scale(1.05);
        }

        /* Main Content Container */
        .content-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 24px;
            margin-top: 20px;
        }
        .card {
            background: #fff;
            color: #222;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        .card h3 {
            font-size: 1.2em;
            margin: 0;
            flex: 1;
            margin-right: 10px;
            line-height: 1.3;
        }
        .score {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            white-space: nowrap;
        }
        .score-high { background: #4CAF50; color: white; }
        .score-medium { background: #FF9800; color: white; }
        .score-low { background: #f44336; color: white; }
        .card-content p {
            font-size: 0.95em;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        .label {
            font-weight: bold;
            color: #555;
        }

        /* Loading States */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            grid-column: 1 / -1;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #9744a7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error States */
        .error-container {
            text-align: center;
            padding: 60px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            border: 2px solid #ff6b6b;
            grid-column: 1 / -1;
        }
        .error-icon {
            font-size: 3em;
            margin-bottom: 20px;
        }
        .retry-btn {
            margin-top: 20px;
            padding: 12px 24px;
            background: #9744a7;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .retry-btn:hover {
            background: #813a90;
        }

        /* Status/Error Message Styling */
        .status-message {
            text-align: center;
            font-size: 1.2em;
            padding: 40px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            grid-column: 1 / -1;
        }
        .status-message.error {
            color: #d93025;
            font-weight: bold;
        }

        /* About Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: flex;
            justify-content: center; align-items: center;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s; z-index: 1000;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: white; padding: 30px 40px; border-radius: 12px;
            max-width: 500px; width: 90%; text-align: center;
            position: relative; transform: scale(0.9); transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h2 { margin-bottom: 15px; }
        .modal-content p { margin-bottom: 10px; line-height: 1.6; }
        .modal-close-btn {
            position: absolute; top: 15px; right: 15px;
            background: none; border: none; font-size: 1.8em;
            cursor: pointer; color: #888;
        }

        /* Footer */
        .footer-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: #222; color: #fff; padding: 24px 32px;
            margin-top: 40px; box-shadow: 0 -2px 8px rgba(0,0,0,0.08);
        }

        /* Additional Status Styling */
        .status-airing {
            color: #4CAF50;
            font-weight: bold;
        }

        .status-finished {
            color: #2196F3;
        }

        .status-other {
            color: #FF9800;
        }

        .result-count {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
            grid-column: 1 / -1;
            border: 2px solid #9744a7;
        }

        .result-count p {
            margin: 0;
            color: #9744a7;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .controls-grid {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                border-right: none;
                border-bottom: 1px solid rgba(0,0,0,0.1);
                justify-content: center;
                text-align: center;
            }
            
            .control-group:last-child {
                border-bottom: none;
            }
            
            .cards {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .main-title {
                font-size: 1.5em;
            }
            
            nav ul {
                gap: 15px;
            }
        }

        @media (max-width: 480px) {
            .control-group {
                flex-direction: column;
                gap: 8px;
            }
            
            .control-group input,
            .control-group select,
            .control-group button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1 class="main-title">AnimeSpace</h1>
        <nav>
            <ul>
                <li><a id="home-link">Home</a></li>
                <li><a id="about-link">About</a></li>
                <li><a id="email-link">Contact</a></li>
            </ul>
        </nav>
    </header>

    <div class="controls-container">
        <div class="controls-grid">
            <div class="control-group">
                <label for="name-search-input">Search by Name:</label>
                <input type="text" id="name-search-input" placeholder="e.g., 'Cowboy Bebop'" minlength="2">
                <button id="name-search-btn">Search</button>
            </div>
            <div class="control-group">
                <label for="year-select">Search by Season:</label>
                <select id="year-select"></select>
                <select id="season-select">
                    <option value="Winter">Winter</option>
                    <option value="Spring">Spring</option>
                    <option value="Summer">Summer</option>
                    <option value="Fall">Fall</option>
                </select>
                <button id="season-search-btn">Get Season</button>
            </div>
            <div class="control-group">
                <label for="rating-select">Filter by Rating:</label>
                <select id="rating-select">
                    <option value="">All</option>
                    <option value="g">G - All Ages</option>
                    <option value="pg">PG - Children</option>
                    <option value="pg13">PG-13</option>
                    <option value="r17">R - 17+</option>
                    <option value="r">R+ (Mild Nudity)</option>
                    <option value="rx">Rx (Hentai)</option>
                </select>
            </div>
        </div>
    </div>

    <main class="content-wrapper">
        <div class="cards"></div>
    </main>

    <div class="modal-overlay" id="about-modal">
        <div class="modal-content">
            <button class="modal-close-btn" id="modal-close">&times;</button>
            <h2>About AnimeSpace</h2>
            <p>This project is a platform for anime fans to discover, search, and explore anime content, powered by the Jikan API.</p>
            <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
            <p><b>Created by:</b></p>
            <p>Varun (Frontend) & Divyesh (Backend)</p>
        </div>
    </div>

    <footer class="footer-bar">
        <div class="footer-left">Thank You</div>
        <div class="footer-right">
            <a href="#" class="social-link">Instagram</a>
            <a href="#" class="social-link">Twitter</a>
            <a href="#" class="social-link">Facebook</a>
        </div>
    </footer>

    <script>
        // DOM Elements
        const homeLink = document.getElementById('home-link');
        const aboutLink = document.getElementById('about-link');
        const aboutModal = document.getElementById('about-modal');
        const modalCloseBtn = document.getElementById('modal-close');
        const nameSearchInput = document.getElementById('name-search-input');
        const nameSearchBtn = document.getElementById('name-search-btn');
        const yearSelect = document.getElementById('year-select');
        const seasonSelect = document.getElementById('season-select');
        const seasonSearchBtn = document.getElementById('season-search-btn');
        const ratingSelect = document.getElementById('rating-select');
        const cardsContainer = document.querySelector('.cards');

        // Configuration - Choose one of these approaches:
        
        // Option 1: Use your backend (Recommended)
        // const API_BASE_URL = "http://localhost:3000/anime";
        
        // Option 2: Direct Jikan API calls (Current fix)
        const API_BASE_URL = "https://api.jikan.moe/v4";
        
        // Search timeout for debouncing
        let searchTimeout;

        // Utility Functions
        function showLoadingSpinner(message = 'Loading...') {
            cardsContainer.innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>${message}</p>
                </div>
            `;
        }

        function showErrorMessage(message, canRetry = true, retryAction = null) {
            const retryButton = canRetry && retryAction ? 
                `<button onclick="${retryAction}()" class="retry-btn">Try Again</button>` : '';
            
            cardsContainer.innerHTML = `
                <div class="error-container">
                    <div class="error-icon">⚠️</div>
                    <h3>Oops! Something went wrong</h3>
                    <p>${message}</p>
                    ${retryButton}
                </div>
            `;
        }

        function showStatusMessage(message, isError = false) {
            cardsContainer.innerHTML = `<div class="status-message ${isError ? 'error' : ''}">${message}</div>`;
        }

        // Better Broadcast Data Handling
        function formatBroadcastData(broadcast) {
            if (!broadcast) return 'Not Scheduled';
            
            const day = broadcast.day || null;
            const time = broadcast.time || null;
            const timezone = broadcast.timezone || null;
            
            if (!day && !time) return 'Not Scheduled';
            if (!day) return time ? `At ${time}` : 'Not Scheduled';
            if (!time) return `${day}s`;
            
            // Clean timezone display
            const timezoneDisplay = timezone && timezone !== 'Unknown' ? ` (${timezone})` : '';
            
            return `${day}s at ${time}${timezoneDisplay}`;
        }

        // Enhanced Data mapping with duplicate removal
        function mapJikanData(animeList) {
            if (!Array.isArray(animeList)) return [];
            
            // Remove duplicates based on MAL ID
            const uniqueAnime = animeList.filter((anime, index, self) => 
                index === self.findIndex(a => a.mal_id === anime.mal_id)
            );
            
            return uniqueAnime.map(anime => ({
                malId: anime.mal_id, // Add unique identifier
                title: anime.title || 'Unknown Title',
                titleEnglish: anime.title_english || anime.title || 'Unknown Title',
                malScore: anime.score,
                status: anime.status,
                rating: anime.rating,
                airDate: anime.aired?.from ? 
                    new Date(anime.aired.from).toUTCString(): 'Unknown',
                airto: anime.aired?.to ? 
                    new Date(anime.aired.to).toUTCString() : 'Unknown' ,
                broadcast: formatBroadcastData(anime.broadcast),
                synopsis: anime.synopsis || 'No synopsis available.',
                episodes: anime.episodes || 'Unknown',
                year: anime.year || (anime.aired?.from ? new Date(anime.aired.from).getFullYear() : 'Unknown')
            }));
        }

        function displayAnime(animeList) {
            cardsContainer.innerHTML = '';
            
            if (!animeList || animeList.length === 0) {
                showStatusMessage('No anime found for this selection. Try different search terms or filters.');
                return;
            }
            
            // Add result count
            const resultCount = document.createElement('div');
            resultCount.className = 'result-count';
            resultCount.innerHTML = `<p>Found ${animeList.length} anime</p>`;
            cardsContainer.appendChild(resultCount);
            
            animeList.forEach(anime => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.malId = anime.malId; // Add unique identifier for debugging
                
                // Score with color coding
                const score = anime.malScore;
                const scoreClass = score >= 8 ? 'score-high' : 
                                 score >= 6 ? 'score-medium' : 
                                 score ? 'score-low' : '';
                
                const scoreDisplay = score ? 
                    `<div class="score ${scoreClass}">⭐ ${score}</div>` : 
                    '<div class="score">⭐ N/A</div>';
                
                // Status indicator
                const statusClass = anime.status === 'Currently Airing' ? 'status-airing' :
                                   anime.status === 'Finished Airing' ? 'status-finished' : 'status-other';
                
                card.innerHTML = `
                    <div class="card-header">
                        <h3 title="${anime.title}">${anime.titleEnglish}</h3>
                        ${scoreDisplay}
                    </div>
                    <div class="card-content">
                        <p><span class="label">Status:</span> <span class="${statusClass}">${anime.status || 'Unknown'}</span></p>
                        <p><span class="label">Rating:</span> ${anime.rating || 'Not Rated'}</p>
                        <p><span class="label">Episodes:</span> ${anime.episodes}</p>
                        <p><span class="label">Air From:</span> ${anime.airDate}</p>
                        <p><span class="label">Air To:</span> ${anime.airto}</p>
                        <p><span class="label">Broadcast:</span> ${anime.broadcast}</p>
                        <p><span class="label">Year:</span> ${anime.year}</p>
                     
                    </div>
                `;
                cardsContainer.appendChild(card);
            });
        }

        // API Functions
        async function fetchFromAPI(url, loadingMessage) {
            showLoadingSpinner(loadingMessage);
            
            try {
                console.log(`Fetching from: ${url}`);
                const response = await fetch(url);
                
                // Check if response is ok
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response received:', text.substring(0, 200));
                    throw new Error('Server returned non-JSON response. Please try again later.');
                }
                
                const result = await response.json();
                console.log('API Response:', result);
                
                // Handle different response structures
                let animeData;
                if (result.data) {
                    // Direct Jikan API or your backend response
                    animeData = Array.isArray(result.data) ? result.data : [result.data];
                } else if (Array.isArray(result)) {
                    // Direct array response
                    animeData = result;
                } else {
                    throw new Error('Unexpected response format');
                }
                
                // Additional validation
                if (animeData.length === 0) {
                    showStatusMessage('No anime found matching your search criteria. Try different terms or filters.');
                    return;
                }
                
                // Map data and remove duplicates
                const mappedData = mapJikanData(animeData);
                
                if (mappedData.length === 0) {
                    showStatusMessage('No valid anime data found. Please try again.');
                    return;
                }
                
                displayAnime(mappedData);
                
            } catch (err) {
                console.error("Fetch error:", err);
                
                let errorMessage = 'An unexpected error occurred. ';
                if (err.message.includes('Failed to fetch')) {
                    errorMessage = 'Network error. Please check your internet connection and try again.';
                } else if (err.message.includes('JSON')) {
                    errorMessage = 'There was an issue with the server response. Please try again later.';
                } else {
                    errorMessage = err.message;
                }
                
                showErrorMessage(errorMessage, true, 'retryLastAction');
            }
        }

        // Search Functions
        let lastAction = null;

        function handleNameSearch() {
            const query = nameSearchInput.value.trim();
            if (!query) {
                showStatusMessage('Please enter an anime name to search.', true);
                return;
            }
            
            if (query.length < 2) {
                showStatusMessage('Please enter at least 2 characters to search.', true);
                return;
            }
            
            const rating = ratingSelect.value;
            
            // Build URL based on API choice
            let url;
            if (API_BASE_URL.includes('localhost') || API_BASE_URL.includes('your-backend')) {
                // Using your backend
                url = `${API_BASE_URL}/search/${encodeURIComponent(query)}?limit=25`;
                if (rating) url += `&rating=${rating}`;
            } else {
                // Direct Jikan API
                url = `${API_BASE_URL}/anime?q=${encodeURIComponent(query)}&limit=25`;
                if (rating) url += `&rating=${rating}`;
            }
            
            lastAction = () => handleNameSearch();
            fetchFromAPI(url, `Searching for "${query}"...`);
        }
        
        function handleSeasonSearch() {
            const year = yearSelect.value;
            const season = seasonSelect.value.toLowerCase();
            const rating = ratingSelect.value;
            
            // Build URL based on API choice
            let url;
            if (API_BASE_URL.includes('localhost') || API_BASE_URL.includes('your-backend')) {
                // Using your backend
                url = `${API_BASE_URL}/${year}/${season}?limit=20`;
                if (rating) url += `&rating=${rating}`;
            } else {
                // Direct Jikan API
                url = `${API_BASE_URL}/seasons/${year}/${season}?limit=20`;
                if (rating) url += `&rating=${rating}`;
            }
            
            lastAction = () => handleSeasonSearch();
            fetchFromAPI(url, `Fetching anime for ${seasonSelect.value} ${year}...`);
        }

        function fetchCurrentSeason() {
            const rating = ratingSelect.value;
            
            // Build URL based on API choice
            let url;
            if (API_BASE_URL.includes('localhost') || API_BASE_URL.includes('your-backend')) {
                // Using your backend
                url = `${API_BASE_URL}/current-season?limit=20`;
                if (rating) url += `&rating=${rating}`;
            } else {
                // Direct Jikan API
                url = `${API_BASE_URL}/seasons/now?limit=20`;
                if (rating) url += `&rating=${rating}`;
            }
            
            lastAction = () => fetchCurrentSeason();
            fetchFromAPI(url, 'Loading current season anime...');
        }

        function retryLastAction() {
            if (lastAction) {
                lastAction();
            } else {
                fetchCurrentSeason();
            }
        }

        // Debounced search function
        function debounceSearch(query) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (query.length >= 2) {
                    handleNameSearch();
                }
            }, 500);
        }

        // Utility Functions
        function populateYearDropdown() {
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = ''; // Clear existing options
            
            for (let year = currentYear; year >= 1990; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            populateYearDropdown();
            fetchCurrentSeason();

            // Navigation
            homeLink.addEventListener('click', fetchCurrentSeason);
            
            // Search functionality
            nameSearchBtn.addEventListener('click', handleNameSearch);
            
            nameSearchInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    handleNameSearch();
                } else {
                    const query = event.target.value.trim();
                    if (query.length >= 2) {
                        debounceSearch(query);
                    } else if (query.length === 0) {
                        clearTimeout(searchTimeout);
                        fetchCurrentSeason();
                    }
                }
            });

            seasonSearchBtn.addEventListener('click', handleSeasonSearch);

            // Modal functionality
            aboutLink.addEventListener('click', () => aboutModal.classList.add('visible'));
            modalCloseBtn.addEventListener('click', () => aboutModal.classList.remove('visible'));
            aboutModal.addEventListener('click', (event) => {
                if (event.target === aboutModal) aboutModal.classList.remove('visible');
            });

            // Rating filter change
            ratingSelect.addEventListener('change', () => {
                if (lastAction) {
                    lastAction();
                } else {
                    fetchCurrentSeason();
                }
            });
        });

        // Global error handler
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            showErrorMessage('An unexpected error occurred. Please refresh the page and try again.');
        });
    </script>
</body>
</html>